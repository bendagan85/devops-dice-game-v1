pipeline {
    agent {
        kubernetes {
            serviceAccount 'jenkins'
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: kubectl-copier
spec:
  containers:
  - name: kubectl
    # ×©×™××•×© ×‘××™××’' ×”××•×›×¨ ×•×”×‘×˜×•×— ×©×œ× ×•
    image: dtzar/helm-kubectl:latest
    command:
    - cat
    tty: true
"""
        }
    }
    
    parameters {
        // ×”××©×ª××© ×™×¢×œ×” ×§×•×‘×¥ ×˜×§×¡×˜ ×“×¨×š ×”×××©×§ ×©×œ ×’'× ×§×™× ×¡
        file(name: 'CONFIG_FILE', description: 'Upload the secret config file (e.g., secret.txt)')
    }

    stages {
        stage('Inject Configuration') {
            steps {
                container('kubectl') {
                    script {
                        echo "ğŸ” Searching for game pods in 'devops' namespace..."
                        
                        // ×©×œ×™×¤×ª ×©××•×ª ×”×¤×•×“×™× ×œ××¢×¨×š
                        // ×©×™× ×œ×‘: ×ª×•×•×“× ×©×”-Label ×ª×•×× ×œ××” ×©×”×’×“×¨×ª ×‘-Deployment
                        def pods = sh(script: "kubectl get pods -n devops -l app=dice-game -o jsonpath='{.items[*].metadata.name}'", returnStdout: true).trim().split(' ')
                        
                        // ×× ×œ× × ××¦××• ×¤×•×“×™×, × ×“×¤×™×¡ ××–×”×¨×”
                        if (pods.length == 0 || pods[0] == "") {
                            error "âŒ No pods found with label app=dice-game in namespace devops!"
                        }

                        // ×œ×•×œ××” ×©×¢×•×‘×¨×ª ×¤×•×“-×¤×•×“ ×•××–×¨×™×§×” ××ª ×”×§×•×‘×¥
                        for (pod in pods) {
                            echo "ğŸ’‰ Injecting file into pod: ${pod}"
                            
                            // 1. ×”×¢×ª×§×” (CP)
                            // $CONFIG_FILE ×”×•× ×”× ×ª×™×‘ ×œ×§×•×‘×¥ ×©×”×¢×œ×™×ª ×œ×’'× ×§×™× ×¡
                            sh "kubectl cp \$CONFIG_FILE devops/${pod}:/app/secret_config.txt"
                            
                            // 2. ×•×™×“×•× (Verify)
                            // ×”×¨×¦×ª ×¤×§×•×“×ª LS ×‘×ª×•×š ×”×¤×•×“ ×›×“×™ ×œ×¨××•×ª ×©×”×§×•×‘×¥ ×”×’×™×¢
                            sh "kubectl exec -n devops ${pod} -- ls -l /app/secret_config.txt"
                        }
                        
                        echo "âœ… Configuration injected successfully into all pods!"
                    }
                }
            }
        }
    }
}