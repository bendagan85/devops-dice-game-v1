pipeline {
    agent {
        kubernetes {
            serviceAccount 'jenkins'
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: kubectl-copier
spec:
  containers:
  - name: kubectl
    image: dtzar/helm-kubectl:latest
    command:
    - cat
    tty: true
"""
        }
    }
    
    parameters {
        // ×©×™× ×•×™: ×‘××§×•× ×œ×”×¢×œ×•×ª ×§×•×‘×¥, × ×‘×§×© ×˜×§×¡×˜ (×”×¨×‘×” ×™×•×ª×¨ ×××™×Ÿ)
        string(name: 'SECRET_CONTENT', defaultValue: 'MY_SECRET_KEY=super_secret_123', description: 'Enter the content of the config file')
    }

    stages {
        stage('Inject Configuration') {
            steps {
                container('kubectl') {
                    script {
                        echo "ğŸ“ Creating secret file locally..."
                        // ×©×œ×‘ 1: ×™×¦×™×¨×ª ×”×§×•×‘×¥ ××ª×•×š ×”×˜×§×¡×˜ ×©×”×–× ×ª
                        writeFile file: 'secret.txt', text: params.SECRET_CONTENT
                        
                        echo "ğŸ” Searching for game pods in 'devops' namespace..."
                        def pods = sh(script: "kubectl get pods -n devops -l app=dice-game -o jsonpath='{.items[*].metadata.name}'", returnStdout: true).trim().split(' ')
                        
                        if (pods.length == 0 || pods[0] == "") {
                            error "âŒ No pods found with label app=dice-game in namespace devops!"
                        }

                        for (pod in pods) {
                            echo "ğŸ’‰ Injecting file into pod: ${pod}"
                            
                            // ×©×œ×‘ 2: ×”×¢×ª×§×ª ×”×§×•×‘×¥ ×©×™×¦×¨× ×• (secret.txt) ×œ×ª×•×š ×”×¤×•×“
                            // ×©×™× ×œ×‘: ×”×¤×¢× ×”×©× ×”×•× ×§×‘×•×¢ ×•×œ×›×Ÿ ×–×” ×œ× ×™×™×›×©×œ
                            sh "kubectl cp secret.txt devops/${pod}:/app/secret_config.txt"
                            
                            // ×©×œ×‘ 3: ×•×™×“×•×
                            sh "kubectl exec -n devops ${pod} -- ls -l /app/secret_config.txt"
                            
                            // ×‘×•× ×•×¡: ×‘×•× × ×¨××” ××” ×™×© ×‘×¤× ×™× (×¨×§ ×‘×©×‘×™×œ ×”×˜×¡×˜)
                            sh "kubectl exec -n devops ${pod} -- cat /app/secret_config.txt"
                        }
                        
                        echo "âœ… Configuration injected successfully into all pods!"
                    }
                }
            }
        }
    }
}