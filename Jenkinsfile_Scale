pipeline {
    agent {
        kubernetes {
            // הגדרת הפוד שיריץ את הפקודות
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: kubectl-agent
spec:
  containers:
  - name: kubectl
    image: bitnami/kubectl:latest
    command:
    - cat
    tty: true
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
"""
        }
    }
    
    parameters {
        // פרמטר בחירת מספר הרפליקות (ברירת מחדל 3)
        string(name: 'REPLICAS', defaultValue: '3', description: 'Number of replicas to scale to')
    }

    stages {
        stage('Debug Info') {
            steps {
                container('kubectl') {
                    script {
                        // 1. נדפיס מה ג'נקינס קיבל מהמשתמש
                        echo "User requested replicas: ${params.REPLICAS}"
                        
                        // 2. נדפיס מה המצב הנוכחי לפני השינוי
                        echo "Current status before scaling:"
                        sh "kubectl get deployment devops-dice-game -n devops"
                    }
                }
            }
        }

        stage('Execute Scale') {
            steps {
                container('kubectl') {
                    script {
                        // 3. ביצוע הפקודה בפועל
                        echo "Executing scale command..."
                        sh "kubectl scale deployment devops-dice-game --replicas=${params.REPLICAS} -n devops"
                        
                        // 4. וידוא שהפקודה נקלטה
                        echo "Status after scaling command:"
                        sh "kubectl get pods -n devops"
                    }
                }
            }
        }
    }
}